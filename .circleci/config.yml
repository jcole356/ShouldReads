version: 2.1
orbs:
  ruby: circleci/ruby@0.1.2

jobs:
  build:
    docker:
      - image: circleci/ruby:2.5.7-node
        environment:
          RAILS_ENV: test
          PG_HOST: localhost

      - image: circleci/postgres:9.4-alpine
    steps:
      - checkout
      - run:
          name: Which bundler?
          command: bundle -v
      - ruby/bundle-install
      - run:
          name: Waiting for Postgres to be ready
          command: |
            for i in `seq 1 10`;
            do
              nc -z localhost 5432 && echo Success && exit 0
              echo -n .
              sleep 1
            done
            echo Failed waiting for Postgres && exit 1
      - run:
          name: setup db
          command: RAILS_ENV=test bundle exec rake db:setup
      - run:
          name: rspec
          command: bundle exec rspec
  # test:
  #   docker:
  #     - image: circleci/ruby:2.5.7
  #   working_directory: ~/project
  #   steps:
  #     - run:
  #         name: PWD and ls
  #         command: pwd && ls
  #     - ruby/test

# workflows:
#   version: 2.1
#   build_and_test:
#     jobs:
#       - build
#       - test:
#           requires:
#            - build
